-- Script de backfill para completar campos nullable antes de hacer NOT NULL\n-- EJECUTAR EN ORDEN Y CON CUIDADO\n\n-- 1. Rellenar campos de Usuario que no tengan empresaId (usuarios del sistema)\n-- Los usuarios ADMIN_SISTEMA que no tienen empresa, se dejan como están\n-- Los ADMIN_EMPRESA deben tener empresaId\n\n-- 2. Rellenar categoria vacíos con una categoría por defecto\nINSERT INTO \"Categoria\" (nombre, \"empresaId\")\nSELECT DISTINCT empresa.id, 'Sin Categoría'\nFROM \"Empresa\" enterprise\nWHERE NOT EXISTS (\n  SELECT 1 FROM \"Categoria\" c WHERE c.\"empresaId\" = empresa.id\n)\nON CONFLICT DO NOTHING;\n\n-- 3. Rellenar clientes sin empresaId\n-- Buscar comprobantes huérfanos y asignarles empresa\nUPDATE \"Cliente\" c\nSET \"empresaId\" = comp.\"empresaId\"\nFROM \"Comprobante\" comp\nWHERE c.id = comp.\"clienteId\" AND c.\"empresaId\" IS NULL\nLIMIT 1000;\n\n-- 4. Para campos que DEBEN tener valor pero permiten NULL, llenar con defaults\nUPDATE \"Usuario\"\nSET telefono = 'SIN_TELÉFONO'\nWHERE telefono IS NULL AND \"rol\" != 'ADMIN_SISTEMA';\n\nUPDATE \"Cliente\"\nSET direccion = 'NO ESPECIFICADO'\nWHERE direccion IS NULL;\n\nUPDATE \"Cliente\"\nSET departamento = 'NO ESPECIFICADO',\n    provincia = 'NO ESPECIFICADO',\n    distrito = 'NO ESPECIFICADO'\nWHERE departamento IS NULL OR provincia IS NULL OR distrito IS NULL;\n\n-- 5. Rellenar empresa con datos por defecto si faltan\nUPDATE \"Empresa\"\nSET departamento = 'NO ESPECIFICADO',\n    provincia = 'NO ESPECIFICADO',\n    distrito = 'NO ESPECIFICADO'\nWHERE departamento IS NULL OR provincia IS NULL OR distrito IS NULL;\n\n-- 6. Verificar datos que podrían quedar huérfanos después de cambios\nSELECT COUNT(*) as usuarios_sin_empresa\nFROM \"Usuario\"\nWHERE \"empresaId\" IS NULL AND \"rol\" != 'ADMIN_SISTEMA';\n\nSELECT COUNT(*) as clientes_sin_empresa\nFROM \"Cliente\"\nWHERE \"empresaId\" IS NULL;\n\nSELECT COUNT(*) as productos_sin_empresa\nFROM \"Producto\"\nWHERE \"empresaId\" IS NULL;\n"